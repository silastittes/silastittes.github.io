<p>The most excellent Hadley Wickham has a <a href="https://www.youtube.com/watch?v=GyNqlOjhPCQ">\textcolor{blue}{great presentation}</a> about functional 
programming where he compares the redundancies in cupcake recipes to the 
construction of for loops. The goal of the presentation is to promote his
new package <code class="highlighter-rouge">purrr</code>, which provides a more comprehensive set of functional
programming tools for <code class="highlighter-rouge">R</code>, and to show audience members the ease and power of a
functional programming approach. I found the analogy and overall point very 
persuasive, so much so, I changed my twitter bio to include the phrase, 
“recovering for loop addict”. I’m no stranger to using the <code class="highlighter-rouge">apply</code> family, but I
never considered it my go-to approach, especially if the task was complex. But
the cupcakes put me over the edge, and I decided to take the plunge as much as 
I could.</p>

<p>I’m still learning <code class="highlighter-rouge">purrr</code>, so I’ll avoid discussing the <code class="highlighter-rouge">map</code> functions just 
yet. Instead I’ll talk about using <code class="highlighter-rouge">lapply()</code> cause it’s the <code class="highlighter-rouge">apply</code> function I 
use most often. The thing I always find most difficult is nesting <code class="highlighter-rouge">lapply()</code> 
calls in an effort to replicate nested loop structures. I thought I would
compare a nested loop and a nested <code class="highlighter-rouge">lapply()</code> call side-by-side to see how they
compare in syntax and efficiency.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1">#vectors to loop over
</span><span class="n">x_vec</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="w"> </span><span class="c1">#change size to see differences in process time
</span><span class="n">y_vec</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x_vec</span><span class="w">

</span><span class="n">c_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Sys.time</span><span class="p">()</span><span class="w">
</span><span class="c1">#store output
</span><span class="n">storage_loop</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">x_vec</span><span class="p">),</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">y_vec</span><span class="p">)))</span><span class="w">
</span><span class="c1">#set_along, following Wickham suggestion
</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nf">seq_along</span><span class="p">(</span><span class="n">x_vec</span><span class="p">)){</span><span class="w">
  </span><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nf">seq_along</span><span class="p">(</span><span class="n">y_vec</span><span class="p">)){</span><span class="w">
    </span><span class="n">storage_loop</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="c1">#fill storage
</span><span class="w">  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">loop_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Sys.time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">c_time</span><span class="w"> </span><span class="c1">#check duration
</span><span class="w">

</span><span class="n">c_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Sys.time</span><span class="p">()</span><span class="w">
</span><span class="n">storage_apply</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="n">as.list</span><span class="p">(</span><span class="n">x_vec</span><span class="p">),</span><span class="w"> 
                        </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">sapply</span><span class="p">(</span><span class="n">as.list</span><span class="p">(</span><span class="n">y_vec</span><span class="p">),</span><span class="w">
                                           </span><span class="k">function</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">))})</span><span class="w">
</span><span class="n">apply_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Sys.time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">c_time</span><span class="w">

</span><span class="n">loop_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">apply_time</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## Time difference of 0.003158092 secs
</code></pre>
</div>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1">#is the same output is produced?
</span><span class="n">mean</span><span class="p">(</span><span class="n">storage_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">storage_apply</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [1] 1
</code></pre>
</div>

<p>This is obviously an overly simplistic example, but I think it demonstrates the 
syntax and efficiency differences quite well. Replacing <code class="highlighter-rouge">paste()</code> with something 
you care about iterating over should be easy once you know how to structure the 
syntax.</p>

<p>Notice <code class="highlighter-rouge">lapply()</code> requires a list as input, hence the conversion of the index 
vectors to list with <code class="highlighter-rouge">as.list()</code>. I like creating line breaks between the the 
list input and the function input. There may be prettier ways to do this, but I 
find this fairly readable.There is also a lot of flexibility concerning the data 
input/output options with <code class="highlighter-rouge">apply</code>, which is  definitely not true for <code class="highlighter-rouge">for</code> loops.</p>

<p>For example, if we wanted to output a linear 1 x n instead of matrix:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1">#changed storage to 1d array, changed the length from n by n to n*n
#added counter to keep track of storage vector index
</span><span class="n">storage_loop</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">x_vec</span><span class="p">)</span><span class="o">*</span><span class="nf">length</span><span class="p">(</span><span class="n">y_vec</span><span class="p">))</span><span class="w">
</span><span class="c1">#set_along, following Wickham suggestion
</span><span class="n">count</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nf">seq_along</span><span class="p">(</span><span class="n">x_vec</span><span class="p">)){</span><span class="w">
  </span><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nf">seq_along</span><span class="p">(</span><span class="n">y_vec</span><span class="p">)){</span><span class="w">
    </span><span class="n">storage_loop</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="c1">#fill storagecount
</span><span class="w">    </span><span class="n">count</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">


</span><span class="c1">#changed outter apply to sapply, and added unlist()
#flipped x and y order in paste to make comparable to loop
</span><span class="n">storage_apply</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unlist</span><span class="p">(</span><span class="n">lapply</span><span class="p">(</span><span class="n">as.list</span><span class="p">(</span><span class="n">x_vec</span><span class="p">),</span><span class="w"> 
                        </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">sapply</span><span class="p">(</span><span class="n">as.list</span><span class="p">(</span><span class="n">y_vec</span><span class="p">),</span><span class="w"> 
                                           </span><span class="k">function</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))}))</span><span class="w">

</span><span class="c1">#is the same output is produced?
</span><span class="n">mean</span><span class="p">(</span><span class="n">storage_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">storage_apply</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [1] 1
</code></pre>
</div>

<p>There may not be many reasons to do this, but it shows the ease of changing 
the structure of the data output from the <code class="highlighter-rouge">lapply()</code>/<code class="highlighter-rouge">sapply()</code> call compared 
to the loop. Not to mention, you can create all sorts of other list structures 
with calls to <code class="highlighter-rouge">apply</code>. These can be useful depending on downstream 
applications. all by changing between <code class="highlighter-rouge">sapply()</code> and <code class="highlighter-rouge">lapply()</code>.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">storage_apply</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lapply</span><span class="p">(</span><span class="n">as.list</span><span class="p">(</span><span class="n">x_vec</span><span class="p">),</span><span class="w"> 
                        </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">lapply</span><span class="p">(</span><span class="n">as.list</span><span class="p">(</span><span class="n">y_vec</span><span class="p">),</span><span class="w"> 
                                           </span><span class="k">function</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))})</span><span class="w">


</span><span class="c1">#just the first chunk
</span><span class="n">storage_apply</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [[1]]
## [1] "1 1"
## 
## [[2]]
## [1] "1 2"
## 
## [[3]]
## [1] "1 3"
## 
## [[4]]
## [1] "1 4"
## 
## [[5]]
## [1] "1 5"
</code></pre>
</div>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">storage_apply</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="n">as.list</span><span class="p">(</span><span class="n">x_vec</span><span class="p">),</span><span class="w"> 
                        </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">lapply</span><span class="p">(</span><span class="n">as.list</span><span class="p">(</span><span class="n">y_vec</span><span class="p">),</span><span class="w"> 
                                           </span><span class="k">function</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))})</span><span class="w">
</span><span class="n">storage_apply</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>##      [,1]  [,2]  [,3]  [,4]  [,5] 
## [1,] "1 1" "2 1" "3 1" "4 1" "5 1"
## [2,] "1 2" "2 2" "3 2" "4 2" "5 2"
## [3,] "1 3" "2 3" "3 3" "4 3" "5 3"
## [4,] "1 4" "2 4" "3 4" "4 4" "5 4"
## [5,] "1 5" "2 5" "3 5" "4 5" "5 5"
</code></pre>
</div>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">storage_apply</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lapply</span><span class="p">(</span><span class="n">as.list</span><span class="p">(</span><span class="n">x_vec</span><span class="p">),</span><span class="w"> 
                        </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">sapply</span><span class="p">(</span><span class="n">as.list</span><span class="p">(</span><span class="n">y_vec</span><span class="p">),</span><span class="w"> 
                                           </span><span class="k">function</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))})</span><span class="w">
</span><span class="n">storage_apply</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [1] "1 1" "1 2" "1 3" "1 4" "1 5"
</code></pre>
</div>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">storage_apply</span><span class="p">[[</span><span class="m">2</span><span class="p">]]</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [1] "2 1" "2 2" "2 3" "2 4" "2 5"
</code></pre>
</div>

<p>Lastly, if you have a multi-core machine, you can speed up calls to <code class="highlighter-rouge">apply</code> with 
the <code class="highlighter-rouge">parallel</code> package without any extra work (unless you count typing 
“library(parallel)” and “mc”. Only do this if you have a large process though,
as there is a bit of a ``start up’’ cost.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">parallel</span><span class="p">)</span><span class="w">

</span><span class="c1">#vectors to loop over
</span><span class="n">x_vec</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">20</span><span class="c1">#00 #change size to see differences in process time
</span><span class="n">y_vec</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x_vec</span><span class="w">

</span><span class="n">c_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Sys.time</span><span class="p">()</span><span class="w">
</span><span class="n">storage_apply</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lapply</span><span class="p">(</span><span class="n">as.list</span><span class="p">(</span><span class="n">x_vec</span><span class="p">),</span><span class="w"> 
                        </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">lapply</span><span class="p">(</span><span class="n">as.list</span><span class="p">(</span><span class="n">y_vec</span><span class="p">),</span><span class="w"> 
                                           </span><span class="k">function</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">))})</span><span class="w">
</span><span class="n">apply_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Sys.time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">c_time</span><span class="w">

</span><span class="n">c_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Sys.time</span><span class="p">()</span><span class="w">
</span><span class="n">storage_apply</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mclapply</span><span class="p">(</span><span class="n">as.list</span><span class="p">(</span><span class="n">x_vec</span><span class="p">),</span><span class="w"> 
                        </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">lapply</span><span class="p">(</span><span class="n">as.list</span><span class="p">(</span><span class="n">y_vec</span><span class="p">),</span><span class="w"> 
                                           </span><span class="k">function</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">))})</span><span class="w">
</span><span class="n">mcapply_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Sys.time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">c_time</span><span class="w">

</span><span class="n">apply_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mcapply_time</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## Time difference of -0.00560236 secs
</code></pre>
</div>

<p>Here is a summary of my current feelings about for loops version functional 
programming approaches:</p>

<p>\begin{center}
    \begin{tabular}{ | p{2.5cm} | p{2.5cm} | p{2.5cm} | p{2.5cm} | p{2.5cm} | }
    \hline
    \bf{\phantom{poop}} &amp; \bf{pro <code class="highlighter-rouge">for</code> loop} &amp; \bf{con <code class="highlighter-rouge">for</code> loop}
    &amp; \bf{pro <code class="highlighter-rouge">apply</code>} &amp; \bf{con <code class="highlighter-rouge">apply</code>} <br />
    \hline \hline
    Syntax &amp; 
    Straight forward, similar across programming languages. Not unpleasant to
    look at. Easier to make one-off test cases to ensure the script does 
    what you intended. &amp; 
    Requires more typing. Requires explicitly allotting storage. &amp;
    Far more compact. &amp;
    Sometimes difficult to write and interpret. Hard to make “pretty” 
    especially with anonymous function calls. Less dealing with storage. <br />
    \hline
    Comp. \newline Efficiency &amp;
    \phantom{slow} &amp;
    slow &amp;
    fast! parallelizable. Even faster! (sometimes) &amp;
    \phantom{fast} <br />
    \hline
    \end{tabular}
\end{center}</p>

<p>In summary, if you’re new to programming and using <code class="highlighter-rouge">R</code>, learn how to use loop 
structures, which will make you more prepared to learn other languages. Once 
you know how to use them, ditch them in <code class="highlighter-rouge">R</code>. If you just can’t get the syntax
to work in <code class="highlighter-rouge">apply</code> calls (or <code class="highlighter-rouge">map</code> calls), go back to your old loopy ways.</p>
